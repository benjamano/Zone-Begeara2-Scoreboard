<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Packet Sniffer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-dark">
    <div class="row justify-content-around m-4">
        <div class="card col-5 p-0">
            <div class="card-header bg-dark-subtle">Spotify Playback Control</div>
            <div class="card-body bg-secondary text-white">
                <button onclick="controlPlayback('toggle')">Play</button>
                <div class="form-group">

                    <label for="ControlSpotify">Control Spotify</label>
                    <input type="checkbox" id="ControlSpotify" name="ControlSpotify" onchange="toggleSpotifyControl()" checked>

                </div>
            </div>

        </div>
        <div class="card col-5 p-0">
            <div class="card-header bg-dark-subtle">Server Control</div>
            <div class="card-body bg-secondary text-white">
                <button onclick="controlPlayback('end')">Terminate</button>
            </div>
        </div>

        <div class="card mt-3 p-0">

            <div class="card-header bg-dark-subtle text-dark">Game Details</div>

            <div class="card-body bg-secondary text-white">

                <h5>Current game status: <span id="gameStatus" class="text-warning">Waiting for game to start...</span></h5>

                <h5>OBS is connected: {{OBSConnected}}</h5>

                <div id="messages"></div>

            </div>

        </div>
    </div>

    <script>

        var controlSpotify = false;

        var socket = io.connect('http://' + document.domain + ':8080', {transports: ['websocket']});

        window.onload = function() {

            socket.on('connect', function() {
                socket.emit('client_event', {data: 'Client connected!'});
                socket.emit('spotifyControlStatus', {data: controlSpotify});
                console.log("SpotifyControl: " + controlSpotify);
                console.log("Client connected!");

                var messageDiv = document.getElementById('messages');

                messageDiv.innerHTML += '<p class="text-success">Connected @ '+Date.now()+'</p>';
            });

            socket.on('start', function(msg) {
                console.log(msg);
                
                var messageDiv = document.getElementById('messages');

                var gameStatus = document.getElementById('gameStatus');

                $("#gameStatus").removeClass("text-warning").addClass("text-success");

                gameStatus.innerHTML = 'Game in progress...';

                messageDiv.innerHTML += '<p class="text-success">' + msg.message + '</p>';
            });

            socket.on('end', function(msg) {
                console.log(msg);

                var messageDiv = document.getElementById('messages');

                var gameStatus = document.getElementById('gameStatus');

                $("#gameStatus").removeClass("text-warning").addClass("text-danger");
                
                gameStatus.innerHTML = 'Game ended at ' + new Date().toLocaleTimeString();

                messageDiv.innerHTML += '<p class="text-danger">' + msg.message + '</p>';
            });

            socket.on('server', function(msg) {
                console.log(msg);

                var messageDiv = document.getElementById('messages');

                messageDiv.innerHTML += '<p class="text-danger">' + msg.message + '</p>';
            });

            socket.on('disconnect', function() {
                var messageDiv = document.getElementById('messages');

                messageDiv.innerHTML += '<p class="text-danger">Disconnected @ '+Date.now()+'</p>';
            });

            socket.on('timeleft', function(msg) {
                var messageDiv = document.getElementById('messages');

                messageDiv.innerHTML += '<p class="text-danger">'+ msg.message +'</p>';
            });
            
        };

        async function toggleSpotifyControl(){
            controlSpotify = !controlSpotify;

            socket.emit('SpotifyControl', {data: controlSpotify});

            console.log("SpotifyControl: " + controlSpotify);
        }

        async function controlPlayback(action) {
            if (action == "end"){
                if (window.confirm("Are you sure you want to terminate the server?")) {
                    const response = await fetch(`/${action}`);
                    const result = await response.json();
                    alert(result.message || result.error);
                }
            }

            const response = await fetch(`/${action}`);
            const result = await response.json();
            alert(result.message || result.error);
        }
    </script>
</body>
</html>
